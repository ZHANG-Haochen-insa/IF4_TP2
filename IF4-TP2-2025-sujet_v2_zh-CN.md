# TP2 移动机器人应用

**INSA 里昂, TP2 IF4 实时系统, 2025-2026**

---

## 1 简介

### 教学目标
在一个微控制器上编程一个控制律，同时保证实时操作。

### 应用
通过WiFi通信，从智能手机远程控制的移动机器人的速度控制。本TP直接重用TD2的结果。

### 交付物
TP后最晚一周需提交一份综合报告。程序需在课程结束时以ZIP压缩包的形式在Moodle上提交。对于报告，请将其添加到您的压缩包中，并在同一位置重新提交。如果您愿意，您可以在此时改进您的程序（例如添加注释）。

---

## 2 逐步实现

### 2.1 PWM信号生成

使用文件 `base_IF4_TP2-BO.zip`。

为此，我们使用ESP32的4个电机控制脉宽调制器（MCPWM）单元（请参阅完整的[Espressif文档¹](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/mcpwm.html)和[实施文档²](https://docs.espressif.com/projects/esp-idf/en/v4.3/esp32/api-reference/peripherals/mcpwm.html)）。PWM信号的值为0或3.3V。ESP32拥有16个独立的PWM通道，可以分配给几乎任何GPIO引脚。在ESP32上，使用Arduino开发环境可以非常简单地配置PWM。您将使用默认可用的`ledc`模块，只需两个函数：`ledcAttach()`，`analogWrite()`。

要生成一个PWM信号，例如在GPIO23引脚上，需要：

- **在配置时:**
    - 选择GPIO引脚23以生成PWM信号；
    - 选择PWM频率；
    - 选择脉冲宽度分辨率在1到16位之间；
- **在应用期间:**
    - 应用一个占空比。

---

### 图1中给出了一个配置和使用的代码示例：

```c
/**
 * 初始化一个PWM
 * cf https://github.com/espressif/arduino-esp32/blob/master/docs/en/migration_guides/2.x_to_3.0.rst#ledc
 */
void init_motor_pwm(uint8_t pin) {
    ledcAttach(pin, PWM_FREQ, PWM_RESOLUTION);
    analogWrite(pin, 0);
}
```
**图1：管理PWM输出的代码示例（此处设置为0）**

在机器人上，与2个电机相关的4个GPIO输出是（为了使车轮在前进时同向转动，两个电机的输出相反）：

- **右电机**：`MRF = 33;` //右前 & `MRB = 32;` //右后
- **左电机**：`MLF = 26;` //左前 & `MLB = 25;` //左后

> **注意：** 请确保将反向（前进/后退）信号保持为0。

> **警告：** 在启动程序之前，请将机器人放在支架上！（以防它从桌子上掉下来）

**提出并测试一个程序，该程序：**

1.  等待1秒；
2.  使机器人前进500毫秒；
3.  等待500毫秒；
4.  使机器人后退500毫秒；
5.  永久停止。

该程序可以是单任务的，或者更好的是双任务的（在这种情况下，现阶段无需担心任务间数据保护）。

**在您的报告中解释您的方法。**

该程序需在TP课程结束时提交到一个Moodle上的压缩包中。压缩包应命名为 **«BO_noms_binome»**。

---

### 2.2 测量转速

每个编码器的2个通道的信号引脚可在以下位置读取：

- **右编码器**：`SRA = 35;` `SRB = 34;`
- **左编码器**：`SLA = 14;` `SLB = 27;`

1.  基于TD2中提出的方法以及您在TP1中学到的知识，实现一个多任务程序，该程序每100毫秒确定一次左电机轮的转速，并通过串口将其发送到PC，持续10秒。
2.  完善您的程序，以便同时显示两个轮子的速度。

> 如果需要共享资源保护，请先在没有保护的情况下实验性地验证您的程序，然后再使用保护...

**在您的报告中解释您的方法。**

该程序将添加到上一个存档中，在课程结束时上传到Moodle。它需要命名为 **«BO_Vitesse_noms_binome»**。

---

### 2.3 速度控制

基于TD2，对左轮速度进行闭环控制。

从 **比例（P）控制器** 开始，然后再转到 **比例积分（PI）** 控制器。

> **警告：** 启动程序时，请注意留出足够长的USB电缆，以免机器人拉扯它。

为了测试，应用一个每500毫秒变化的阶跃设定点：0，然后是2.5 rad/s，然后是-2.5 rad/s，最后是0。

在串行端口上显示速度设定点、测量速度和控制信号：每个周期一行，值用制表符分隔。将此信息保存在TSV格式的文件中。在EXCEL或MATLAB中以图形方式显示它。

一旦闭环控制经过实验验证，完善该程序以控制两个轮子。**在您的报告中解释您的方法和结果。**

> 如果需要共享资源保护，请先在没有保护的情况下实验性地验证您的程序，然后再使用保护...

该程序将添加到上一个存档中。它需要命名为 **«BF_noms_prenoms»**。

---

### 2.4 WiFi通信集成

使用文件 `base_IF4_TP2-WiFi.zip`。

1.  恢复上一个程序的闭环控制任务。
2.  要配置通信，请修改您的机器人的SSID和密码（程序开头的常量），以防止您的邻居入侵您的机器人。您的机器人的WiFi热点是通过在`setup()`函数中调用的`wifi_start(ssid, password)`函数初始化的。
3.  创建一个函数 (`update_desired_speeds()`)，该函数根据WiFi通信函数`communicate_with_phone()`（参见TD2）接收到的值，修改电机的期望速度，以允许机器人前进/后退/向左/向右和停止。
4.  在您的通信任务中，永久调用`communicate_with_phone()`函数以响应手机浏览器的请求。
5.  编译并烧录ESP32，然后打开您的手机，连接到您在步骤2中分配了名称和密码的WiFi网络。
6.  使用串行控制台中显示的IP地址 (`w.x.y.z`)（`http://192.168.X.1`，X=4在大多数情况下，否则请查看您的WiFi连接参数），在浏览器中打开。
7.  测试并调试您的程序。

> 如果需要共享资源保护，请先在没有保护的情况下实验性地验证您的程序，然后再使用保护...

该程序将添加到上一个存档中。它需要命名为 **«Remote»**。

---

## 3 更进一步

一些想法（按难度递增顺序）：

-   添加一个STOP按钮；
-   在手机上显示车轮速度；
-   从手机上调整前进速度；
-   编程一些动作（1/2圈，平行停车...）；
-   ...

---
_IF4-TP2-2025-sujet v2_
