# 基于FreeRTOS的移动机器人速度控制系统

**INSA Lyon, IF4 实时系统 TP2**

**作者：** Haiwei CHEN, Haochen ZHANG

**日期：** 2025年11月28日

---

## 摘要

本实验在ESP32微控制器平台上实现了一个完整的移动机器人实时控制系统。系统基于FreeRTOS实时操作系统，集成了PWM电机驱动、增量式编码器测速、PI闭环速度控制以及WiFi无线通信功能。通过多任务并行架构，系统实现了对双轮差速机器人的精确速度控制（稳态误差<1%）和远程无线遥控功能。实验结果表明，PI控制器相较于P控制器能有效消除稳态误差，系统整体满足实时性要求。

---

## 1. 引言

移动机器人的速度控制是实时嵌入式系统的典型应用场景。本实验旨在通过ESP32微控制器实现一个包含感知、控制和通信的完整机器人系统。实验分为四个递进阶段：首先实现基于PWM的开环电机驱动，随后集成编码器实现速度反馈，在此基础上设计并实现PI闭环控制器，最后通过WiFi通信实现远程遥控功能。整个系统采用FreeRTOS多任务架构，通过任务优先级调度保证控制回路的实时性。

---

## 2. 系统硬件架构

本实验使用的移动机器人平台配备ESP32双核微控制器，搭载两个带减速器的直流电机和两个增量式编码器。电机通过H桥驱动电路接收PWM控制信号，每个电机具有两个控制引脚（前进和后退方向）。编码器采用双通道正交输出，每转产生11个脉冲，配合30:1的减速比和四倍频解码方式，理论分辨率达到1320脉冲/转。

ESP32的硬件资源分配如下：GPIO 26、25控制左电机前进和后退，GPIO 33、32控制右电机；GPIO 14、27连接左编码器的A、B相，GPIO 35、34连接右编码器。PWM信号通过ESP32的LEDC模块生成，频率设置为1kHz，分辨率为15位（0-32767范围），能够提供精细的速度控制。

---

## 3. 开环PWM控制实现

### 3.1 PWM信号生成原理

ESP32的LEDC模块提供了灵活的PWM生成能力。通过`ledcAttach()`函数将GPIO引脚绑定到PWM通道，并设置频率和分辨率。随后使用`analogWrite()`函数即可动态调整占空比。本实验选择1kHz的PWM频率是基于电机机械时间常数的考虑，该频率既能保证平滑的转速控制，又避免了过高频率带来的开关损耗。

### 3.2 多任务架构设计

程序采用双任务架构实现预定的运动序列（等待500ms → 前进500ms → 停止500ms → 后退500ms → 永久停止）。Setup任务负责硬件初始化，完成后创建MotorControl任务并挂起自己，避免Arduino框架中`loop()`函数的干扰。MotorControl任务使用FreeRTOS的`vTaskDelay()`函数实现精确的时序控制，任务完成后通过`vTaskDelete(NULL)`自行删除，释放系统资源。

这种架构的关键在于正确处理Arduino-ESP32框架与FreeRTOS的集成问题。由于`setup()`和`loop()`运行在同一个FreeRTOS任务中，若不加处理，`loop()`会持续执行干扰控制逻辑。解决方案是在`setup()`结束前调用`vTaskSuspend(xTaskGetCurrentTaskHandle())`将当前任务挂起。

---

## 4. 速度测量系统

### 4.1 编码器四倍频解码

增量式编码器的两相正交信号包含了转动方向和速度信息。本实验采用状态机方法实现四倍频解码：在A、B两相的每个边沿都触发中断，通过分析状态转换序列（正转：00→01→11→10→00，反转：00→10→11→01→00）判断转动方向，并累加计数器。这种方法将分辨率提升四倍，达到1320脉冲/转，显著提高了低速时的测量精度。

中断服务程序（ISR）使用`IRAM_ATTR`属性确保代码存储在内部RAM中，减少执行延迟。每个中断中读取当前AB状态，与上一状态比较后确定方向（+1或-1），更新全局计数器。为避免数据竞争，主任务读取计数器时使用`portENTER_CRITICAL`/`portEXIT_CRITICAL`临界区保护，确保操作的原子性。

### 4.2 速度计算与周期性任务

速度测量任务以100ms为周期运行，每个周期读取并重置编码器计数，根据公式 $\omega = \frac{\Delta N}{N_{rev}} \cdot \frac{2\pi}{T}$ 计算角速度（单位：rad/s），其中 $\Delta N$ 为周期内脉冲数，$N_{rev}=1320$ 为每转脉冲数，$T=0.1s$ 为测量周期。该任务使用`vTaskDelayUntil()`而非`vTaskDelay()`实现周期性执行，前者基于绝对时间避免了相对延时的累积误差，保证测量周期的稳定性。

电机控制任务以较低优先级运行，执行预定的前进-后退序列。速度测量任务的高优先级保证了即使电机控制任务占用CPU，速度采样仍能按时执行。实验持续10秒，数据通过串口以制表符分隔格式输出，便于后续的图形化分析。

---

## 5. 闭环速度控制设计

### 5.1 控制理论基础

闭环控制的目标是使电机速度精确跟踪给定的设定值。本实验对比了比例（P）控制器和比例积分（PI）控制器的性能。P控制器的控制律为 $u(t) = K_p \cdot e(t)$，其中误差 $e(t)=r(t)-y(t)$ 为设定值与测量值之差。P控制器响应迅速但存在固有的稳态误差：当误差减小时控制输出也减小，系统在达到稳态前会平衡于某个非零误差。

PI控制器通过引入积分项 $u(t) = K_p \cdot e(t) + K_i \cdot \int_0^t e(\tau)d\tau$ 解决了稳态误差问题。积分项累积历史误差，即使瞬时误差很小，只要积分项非零，系统就会继续调整输出直至误差完全消除。离散化后的控制律为 $u[k] = K_p \cdot e[k] + K_i \cdot T \cdot \sum_{i=0}^{k}e[i]$，其中 $T$ 为控制周期。

### 5.2 控制器参数整定

实验采用试凑法整定控制器参数。初始尝试 $K_p=3000$，系统响应缓慢且稳态误差达60%。逐步增大 $K_p$ 至6000改善了响应速度，但P控制器无法消除稳态误差（图1）。引入积分项后，设置 $K_i=8000$，系统稳态误差降至0.8%（图2）。

![P控制器响应](BF_CHEN_Haiwei_ZHANG_Haochen/p_controller_response.png)
**图1：** P控制器阶跃响应曲线。上图显示设定速度（蓝线）与测量速度（红线），可见明显的稳态误差（约60%）。下图为对应的控制信号。设定点序列为 0 → 2.5 → -2.5 → 0 rad/s，每个阶跃持续5秒。

![PI控制器响应](BF_CHEN_Haiwei_ZHANG_Haochen/pi_controller_response.png)
**图2：** PI控制器阶跃响应曲线（$K_p=6000$, $K_i=8000$）。测量速度能够快速跟踪设定值，稳态误差小于1%。注意到在阶跃时刻存在轻微超调（如5秒时刻达到2.8 rad/s），这是积分项快速累积导致的，但系统在约1秒后即稳定。控制信号在阶跃时刻达到饱和极限，随后稳定在维持稳态所需的水平。

为防止积分饱和（windup）现象，实现了积分限幅机制：当积分项超过 $\pm 15000$ 时进行截断。同时，在设定值发生阶跃变化时重置积分项，避免旧的积分值影响新的控制过程。控制周期设置为100ms（后续优化至50ms），平衡了控制性能与计算负担。

### 5.3 性能分析

从图2可以观察到PI控制器的典型特征：正向阶跃时（0→2.5 rad/s）存在约12%的超调（峰值2.8 rad/s），但调节时间约1.5秒，之后稳态误差保持在0.02 rad/s以内（0.8%）。负向阶跃时（2.5→-2.5 rad/s）出现更大的瞬态偏差，这是因为电机需要完全反向，期间存在机械摩擦和电气延迟。控制信号曲线显示在阶跃时刻PWM值快速变化至极限值（±32767附近），表明控制器充分利用了执行器能力。

相比之下，图1的P控制器虽然初始响应较快，但最终只能达到约1.0 rad/s（设定值40%），且控制信号稳定在较低水平（约5000），无法提供足够的驱动力克服摩擦等扰动。这验证了PI控制器的积分作用对于消除稳态误差的必要性。

---

## 6. WiFi通信与系统集成

### 6.1 无线遥控架构

最终系统将闭环控制扩展至双轮独立控制，并集成WiFi通信实现远程遥控。ESP32配置为AP（接入点）模式，创建SSID为"MonRobot"的WiFi热点。手机连接该热点后，通过浏览器访问`http://192.168.4.1`即可显示控制界面，包含前进、后退、左转、右转四个方向按钮。

HTTP服务器由`communicate_with_phone()`函数实现，解析URL路径识别用户指令（如`/26/on`对应前进）。收到指令后，`update_desired_speeds()`函数根据运动学模型更新双轮的期望速度：前进时两轮同向旋转（均为2.5 rad/s），后退时同向反转（均为-2.5 rad/s），左转时左轮反转、右轮正转（±1.5 rad/s），右转则相反。通过差速驱动实现了原地转向的能力。

### 6.2 多任务协调与资源保护

系统包含两个主要任务：wifiCommunicationTask（优先级1）以10ms周期轮询HTTP请求，处理用户指令并更新期望速度；speedControlTask（优先级2）以50ms周期执行双轮独立的PI控制，读取编码器、计算速度误差、更新积分项并输出PWM控制信号。

两个任务通过全局变量`desiredSpeedLeft`和`desiredSpeedRight`共享期望速度信息。由于ESP32是双核处理器，两个任务可能真正并行执行，因此必须使用临界区保护这些共享变量。写入时（WiFi任务）和读取时（控制任务）都通过`portENTER_CRITICAL(&speedMutex)`加锁，确保操作的原子性。这种基于自旋锁的保护机制延迟极低（微秒级），不会影响控制任务的实时性。

优先级设计遵循实时系统原则：控制任务优先级高于通信任务，保证在CPU资源竞争时控制回路优先执行。控制周期从100ms优化至50ms，提升了系统带宽和抗扰能力。WiFi任务的10ms轮询周期保证了人机交互的流畅性（延迟<100ms）。

### 6.3 实验验证

实际测试表明系统工作稳定可靠。手机发送指令后，机器人在50-100ms内响应运动。闭环控制保证了各种运动模式下的速度精确性：直线运动时两轮速度误差<2%，转向运动流畅无抖动。系统能够连续运行无死锁或任务饥饿现象，验证了多任务架构和资源保护机制的正确性。

---

## 7. 结论

本实验成功实现了一个完整的嵌入式实时控制系统，集成了传感、控制、驱动和通信等多个子系统。通过FreeRTOS多任务架构，系统在保证控制回路实时性的同时实现了灵活的功能扩展。PI控制器的引入使速度跟踪精度从P控制器的60%误差提升至不足1%，验证了控制理论在实际系统中的有效性。WiFi通信模块的集成展示了物联网技术在机器人控制中的应用前景。

实验过程中遇到的多项技术问题（任务调度冲突、数据竞争、积分饱和等）都通过系统分析和针对性设计得到解决，这些经验对于实时嵌入式系统开发具有重要参考价值。未来可以在此基础上进一步研究轨迹跟踪控制、障碍物避障、多机器人协同等更复杂的应用场景。

---

## 附录：代码结构

```
IF4_TP2/
├── BO_CHEN_ZHANG/                    # 开环PWM控制实验
│   └── base_IF4_TP2_BO_v2024_1.ino
├── BO_Vitesse_CHEN_ZHANG/            # 速度测量实验
│   └── BO_Vitesse.ino
├── BF_CHEN_Haiwei_ZHANG_Haochen/     # 闭环速度控制实验
│   ├── BF.ino
│   ├── plot_p_controller.py
│   ├── plot_pi_controller.py
│   ├── p_controller_response.png
│   └── pi_controller_response.png
└── Remote/                           # WiFi遥控集成实验
    ├── Remote.ino
    ├── ESP32Encoder.cpp
    ├── ESP32Encoder.h
    ├── http_server.cpp
    └── http_server.hpp
```

---

**致谢：** 感谢INSA Lyon IF4实时系统课程组提供的实验平台和技术支持。
